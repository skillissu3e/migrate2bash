(()=>{try{document.addEventListener("contextmenu",e=>e.preventDefault())}catch(e){}function p(e){return document.querySelector(`#${e}`)}function s(e){if((e.match(/\*/g)||[]).length==1&&(e.match(/\./g)||[]).length==1)return false;if(typeof e!=="string")return false;let o=e.split(".");if(o.length<=1)return false;let r=o.pop();let a=/^[a-zA-Z0-9-]+$/gi;if(!a.test(r))return false;let s=o.every(e=>{let o=/^(?!:\/\/)([a-zA-Z0-9\*]|[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9])$/gi;return o.test(e)});return s}function k(e){return e==false}function D(o){return new Promise(e=>{chrome.storage.local.set(o,e)})}function v(o){return new Promise(e=>{chrome.storage.local.get(o,e)})}function a(e){return new Promise(o=>{chrome.permissions.request({permissions:[e]},e=>{return o(e)})})}function n(e){return new Promise(o=>{chrome.permissions.contains({permissions:[e]},e=>{return o(e)})})}async function e(){const{uid:e}=await v("uid");p("uid").innerText=e;p("ver").innerText=chrome.runtime.getManifest().version}async function o(){const e=await v(["noProxyDomains","onlyProxyDomains","addProxyDomains"]);$("#noProxyDomains").tagEditor({initialTags:e.noProxyDomains,placeholder:"*.domain.com",onChange:function(e,o,r){let a=[];for(let e=0;e<r.length;e++){if(s(r[e])){a.push(r[e])}else{b("Неправильный формат домена","#ff0000");$("#noProxyDomains").tagEditor("removeTag",r[e])}}}});$("#onlyProxyDomains").tagEditor({initialTags:e.onlyProxyDomains,placeholder:"*.domain.com",onChange:function(e,o,r){let a=[];for(let e=0;e<r.length;e++){if(s(r[e])){a.push(r[e])}else{b("Неправильный формат домена","#ff0000");$("#onlyProxyDomains").tagEditor("removeTag",r[e])}}}});$("#addProxyDomains").tagEditor({initialTags:e.addProxyDomains,placeholder:"*.domain.com",onChange:function(e,o,r){let a=[];for(let e=0;e<r.length;e++){if(s(r[e])){a.push(r[e])}else{b("Неправильный формат домена","#ff0000");$("#addProxyDomains").tagEditor("removeTag",r[e])}}}})}function b(e,o){const r=p("message"),a=p("msgContainer");r.parentNode.removeChild(r);a.appendChild(r);r.style.color=o;r.innerText=e;r.style.display="table"}function r(o,r){o.addEventListener("change",async()=>{if(o.id=="userProxy"){if(o.checked){r.style.display="block"}else{r.style.display="none"}}else if(o.id=="disableExtensions"){const e=await n("management");if(!e){if(o.checked){let e=await a("management");if(e){D({disableExtensions:true})}}else{D({disableExtensions:false})}E()}}})}async function E(){const e=p("proxyMenu"),o=p("disableExtensions"),r=p("userProxy"),a=p("host"),s=p("port"),n=p("dropProxy"),l=p("displayIcon"),t=p("userDomains"),i=p("noProxy"),y=p("onlyProxy"),d=p("addProxy"),c=p("allProxy");const f=await v();if(f.icon==true){l.checked=true}else{l.checked=false}if(f.disableExtensions==true){o.checked=true}else{o.checked=false}if(f.user_proxy==true){r.checked=true;e.style.display="block";n.value=f.user_proxy_type;a.value=f.user_proxy_http;s.value=f.user_proxy_port}else{r.checked=false;e.style.display="none"}if(f.noProxy==true){i.checked=true}else{i.checked=false}if(f.onlyProxy){if(f.onlyProxyDomains.length==0){y.checked=false}else{y.checked=true}}else{y.checked=false}if(f.addProxy==true){d.checked=true}else{d.checked=false}if(f.allProxy==true){c.checked=true}else{c.checked=false}if(f.userDomains==true){t.checked=true}else{t.checked=false;i.checked=false;y.checked=false;d.checked=false;c.checked=false}}async function l(){const r=p("message"),e=p("saveSettings"),o=p("notSaveSettings"),a=p("proxyMenu"),s=p("dropProxy"),n=p("host"),l=p("port"),t=p("opt"),y=p("main"),d=p("displayIcon"),c=p("userProxy"),f=p("disableExtensions"),u=p("domainsMenu"),x=p("noProxy"),P=p("onlyProxy"),m=p("addProxy"),g=p("allProxy");let h=false;e.onclick=async()=>{const e=await v();if(d.checked){D({icon:true});h=true}else{D({icon:false});h=true}if(c.checked){if(n.value&&n.value.length>6&&l.value&&l.value.length>0){D({user_proxy:true,user_proxy_type:s.value,user_proxy_http:n.value,user_proxy_port:l.value});h=true}else{D({user_proxy:false,onlyProxy:false,addProxy:false,allProxy:false});b("Неправильный формат прокси","#ff0000");chrome.runtime.sendMessage({apply:"rebuild"});return}}else{D({user_proxy:false});h=true}if(f.checked){D({disableExtensions:true});h=true}else{D({disableExtensions:false});h=true}if(userDomains.checked){if(!x.checked&&!P.checked&&!m.checked&&!g.checked){b("Необходимо выбрать хотя бы одну из опций","#ff0000");D({userDomains:false,noProxy:false,onlyProxy:false,addProxy:false,allProxy:false});chrome.runtime.sendMessage({apply:"rebuild"});return}if(g.checked&&(P.checked||m.checked)){b("Выбранные опции нельзя использовать вместе","#ff0000");if(!c.checked){D({allProxy:false})}chrome.runtime.sendMessage({apply:"rebuild"});return}if(P.checked&&m.checked){b("Выбранные опции нельзя использовать вместе","#ff0000");if(!c.checked){D({onlyProxy:false,allProxy:false})}let e=await v(["noProxy","onlyProxy","addProxy","allProxy"]);if(Object.values(e).every(k)){D({userDomains:false})}chrome.runtime.sendMessage({apply:"rebuild"});return}if(x.checked&&P.checked){b("Выбранные опции нельзя использовать вместе","#ff0000");if(!c.checked){D({allProxy:false})}chrome.runtime.sendMessage({apply:"rebuild"});return}if(x.checked&&g.checked){if(c.checked){const o=await v("noProxyDomains");if($("#noProxyDomains").tagEditor("getTags")[0].tags.length==0){b("Список доменов не должен быть пустым","#ff0000");D({noProxy:false});chrome.runtime.sendMessage({apply:"rebuild"});return}D({noProxy:true,allProxy:true,addProxy:false,onlyProxy:false,noProxyDomains:$("#noProxyDomains").tagEditor("getTags")[0].tags});h=true}else{b("Опция доступна только со своими прокси","#ff0000");D({allProxy:false});chrome.runtime.sendMessage({apply:"rebuild"});return}}else if(x.checked&&m.checked){if(c.checked){const o=await v(["noProxyDomains","addProxyDomains"]);if($("#noProxyDomains").tagEditor("getTags")[0].tags.length==0){b("Список доменов не должен быть пустым","#ff0000");D({noProxy:false,allProxy:false});let e=await v(["noProxy","onlyProxy","addProxy","allProxy"]);if(Object.values(e).every(k)){D({userDomains:false})}chrome.runtime.sendMessage({apply:"rebuild"});return}if($("#addProxyDomains").tagEditor("getTags")[0].tags.length==0){b("Список доменов не должен быть пустым","#ff0000");D({noProxy:false,addProxy:false,allProxy:false});chrome.runtime.sendMessage({apply:"rebuild"});return}D({noProxy:true,onlyProxy:false,addProxy:true,allProxy:false,noProxyDomains:$("#noProxyDomains").tagEditor("getTags")[0].tags,addProxyDomains:$("#addProxyDomains").tagEditor("getTags")[0].tags});h=true}else{b("Опция доступна только со своими прокси","#ff0000");D({addProxy:false});chrome.runtime.sendMessage({apply:"rebuild"});return}}else if(x.checked){const o=await v("noProxyDomains");if($("#noProxyDomains").tagEditor("getTags")[0].tags.length==0){b("Список доменов не должен быть пустым","#ff0000");D({noProxy:false,userDomains:false});chrome.runtime.sendMessage({apply:"rebuild"});return}D({noProxy:true,onlyProxy:false,addProxy:false,allProxy:false,noProxyDomains:$("#noProxyDomains").tagEditor("getTags")[0].tags});h=true}else if(P.checked){if(c.checked){const o=await v("onlyProxyDomains");if($("#onlyProxyDomains").tagEditor("getTags")[0].tags.length==0){b("Список доменов не должен быть пустым","#ff0000");D({noProxy:false,onlyProxy:false,addProxy:false,allProxy:false});let e=await v(["noProxy","onlyProxy","addProxy","allProxy"]);if(Object.values(e).every(k)){D({userDomains:false})}chrome.runtime.sendMessage({apply:"rebuild"});return}D({onlyProxy:true,noProxy:false,addProxy:false,allProxy:false,onlyProxyDomains:$("#onlyProxyDomains").tagEditor("getTags")[0].tags});h=true}else{b("Опция доступна только со своими прокси","#ff0000");D({onlyProxy:false});let e=await v(["noProxy","onlyProxy","addProxy","allProxy"]);if(Object.values(e).every(k)){D({userDomains:false})}chrome.runtime.sendMessage({apply:"rebuild"});return}}else if(m.checked){if(c.checked){const o=await v("addProxyDomains");if($("#addProxyDomains").tagEditor("getTags")[0].tags.length==0){b("Список доменов не должен быть пустым","#ff0000");D({noProxy:false,onlyProxy:false,addProxy:false,allProxy:false});let e=await v(["noProxy","onlyProxy","addProxy","allProxy"]);if(Object.values(e).every(k)){D({userDomains:false})}chrome.runtime.sendMessage({apply:"rebuild"});return}D({addProxy:true,noProxy:false,onlyProxy:false,allProxy:false,addProxyDomains:$("#addProxyDomains").tagEditor("getTags")[0].tags});h=true}else{b("Опция доступна только со своими прокси","#ff0000");D({addProxy:false});let e=await v(["noProxy","onlyProxy","addProxy","allProxy"]);if(Object.values(e).every(k)){D({userDomains:false})}h=false;chrome.runtime.sendMessage({apply:"rebuild"});return}}else if(g.checked){if(c.checked){D({allProxy:true,noProxy:false,onlyProxy:false,addProxy:false});h=true}else{b("Опция доступна только со своими прокси","#ff0000");D({allProxy:false});let e=await v(["noProxy","onlyProxy","addProxy","allProxy"]);if(Object.values(e).every(k)){D({userDomains:false})}chrome.runtime.sendMessage({apply:"rebuild"});return}}D({userDomains:true})}else{D({userDomains:false,noProxy:false,onlyProxy:false,addProxy:false,allProxy:false});E();h=true}if(h){chrome.runtime.sendMessage({apply:"rebuild"});b("Настройки успешно сохранены","#15d215")}};o.onclick=async()=>{const e=await v();r.style.display="none";E();if(e.icon==true){d.checked=true}else{d.checked=false}if(e.user_proxy==true){c.checked=true}else{c.checked=false}t.style.display="none";y.style.display="block";function o(r,e){if(e&&e.length>0){let o;o=$(r).tagEditor("getTags")[0].tags;for(i=0;i<o.length;i++){$(r).tagEditor("removeTag",o[i],true)}o=e;for(let e=0;e<o.length;e++){$(r).tagEditor("addTag",o[e],true)}}else{let e=$(r).tagEditor("getTags")[0].tags;for(i=0;i<e.length;i++){$(r).tagEditor("removeTag",e[i],true)}}}o("#noProxyDomains",e.noProxyDomains);o("#onlyProxyDomains",e.onlyProxyDomains);o("#addProxyDomains",e.addProxyDomains)}}E();r(p("userProxy"),p("proxyMenu"));r(p("disableExtensions"));l();e();o()})();