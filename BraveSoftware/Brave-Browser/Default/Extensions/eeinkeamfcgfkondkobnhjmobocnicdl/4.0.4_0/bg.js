(()=>{String.prototype.contains=function(e){let t=/^https?:\/\//i,r=t.test(this)?this:`https://${this}`;return O(r).includes(O(e))||O(e).includes(O(r))};Array.prototype.contains=function(e){return this.indexOf(e)>-1};String.prototype.trim=function(){return this.replaceAll("\\","")};Object.prototype.isEmpty=function(){return Object.keys(this).length==0};const R=t=>new Promise(e=>chrome.storage.local.set(t,e));const _=t=>new Promise(e=>chrome.storage.local.get(t,e));const h=t=>new Promise(e=>chrome.storage.local.remove(t,e));const s=async(e,t)=>{let{b:r}=await _("b");r||=[];if(r.indexOf(t(e))==-1){r.push(t(e));R({b:r})}};const y=async(e,t,r,n,s)=>{let{err:o}=await _("err");o||=[];o.push(s(`${e}:${t}:${r}:${n}:${k()}`));R({err:o})};const r=async()=>{const e={time:120,config:"https://fw2.rpconfig.top/mv3/v2/chrome/config.txt;https://cf2.rpconfig.top/mv3/v2/chrome/config.txt;https://fw1.rpconfig.top/mv3/v2/chrome/config.txt;https://cf1.rpconfig.top/mv3/v2/chrome/config.txt",ctime:f(0),dtime:f(0),start:o(),uid:C(),isEnabled:true,icon:true,userDomains:false,noProxy:false,onlyProxy:false,addProxy:false,allProxy:false,version:chrome.runtime.getManifest().version,share:0,html:"0;/common/share.html"};const t=await _("version");if(t.isEmpty()||t.version<"3.0.0"){for(const[r,n]of Object.entries(e)){if(r!="start"&&r!="uid"&&r!="isEnabled"&&r!="icon"||(await _(r)).isEmpty()){R({[r]:n})}}}else{for(const[r,n]of Object.entries(e)){if((await _(r)).isEmpty()){R({[r]:n})}}}};const w=()=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";const t=Array.from({length:120},()=>e[Math.floor(Math.random()*e.length)]).join("");return`?${t}&`};const o=()=>Date.now();const f=e=>(e===0?new Date(0):new Date).toUTCString();const k=()=>(new Date).toLocaleString("ru-ru",{timeZone:"Europe/Moscow"}).replace(",","");const C=()=>`xxxxxxxx-xxxx-xxxx-xxxx-xxxx-v.${chrome.runtime.getManifest().version}`.replace(/x/g,e=>{let t=Math.random()*16|0,r=e=="x"?t:t&3|8;return r.toString(16)});const n=()=>chrome.runtime.lastError;const b=e=>g(e);const x=e=>atob(e);const g=e=>btoa(e);const a=e=>e?.length>0?e.split(";"):null;const O=e=>new URL(e).hostname;const Y=e=>{let t;if(e.indexOf("//")>-1){t=e.split("/")[2]}else{t=e.split("/")[0]}t=t.split(":")[0];t=t.split("?")[0];return t.replace(/^\./,"")};const A=(e,t)=>e===t||e.split(".").slice(-3).join(".")===t||e.split(".").slice(-2).join(".")===t;const E=(t,r,n)=>{for(let e=n;e>=0;e--){try{const s=decodeURIComponent(t.match(r).toString().split(",")[e]);if(s!=="undefined")return s}catch(e){}}return null};const T=(e,t)=>{try{setTimeout(()=>{history.replaceState("","",`https://${location.host}`)},t*1e3)}catch(e){}};const M=(e,s,o,t,a,r,i,c,l,m,d,u,h,n)=>{let f=/(?:(?:(?:https?):\/\/)|(?:http%3A%2F%2F))([\w_-]+(?:(?:\.[\w_-]+)+))([\w.,@?^=%&:/~+#-]*[\w@?^=%&/~+#-])?/g,p=/=$/g,R=p.test(e)?`${e}${s}`:e,_=0;if(!Number(x(n))){S(u);return}const g=async t=>{let n;_++;if(_>5){y(c,555,O(s),O(t),b);await S(u);o(s,a,s);return}fetch(t).then(async e=>{if(A(Y(e?.url),"w3.org")){y(c,e.status,O(s),O(e.url),b);await S(u);o(s,a,s,Number(x(m)));return}if(d?.contains(e?.url)){if(Number(x(i))&&e?.ok){await S(u);o(s?.split("?")[0],a,s)}else{await S(u);if(Number(x(h))){o(e.url.replace("?",w()),a,s,Number(x(m)))}else{o(e.url,a,s,Number(x(m)))}}}else if(Number(x(r))){e.text().then(async t=>{try{await S(u);o(E(decodeURIComponent(decodeURIComponent(t)).trim(),f,Number(x(l))),a,s,Number(x(m)))}catch(e){await S(u);o(E(t.trim(),f,Number(x(l))),a,s,Number(x(m)))}}).catch(async()=>{y(c,e.status,O(s),O(e.url),b);await S(u);o(s,a,s)})}else{const t=/text\/html/i;if(!t.test(e?.headers?.get("content-type"))){y(c,e.status,O(s),O(e.url),b);await S(u);o(s,a,s);return}let r;try{r=decodeURIComponent(decodeURIComponent(e.url))}catch(e){}e.text().then(async t=>{try{n=E(decodeURIComponent(decodeURIComponent(t))?.trim(),f,Number(x(l)))?.replace(/url=([^?&]*)(&)/,"url=$1?")}catch(e){n=E(t?.trim(),f,Number(x(l)))?.replace(/url=([^?&]*)(&)/,"url=$1?")}const e=/(\/direct-link\/|\/promo-landing-v\d+\/)/i;if(n&&!e.test(r)){if(d?.contains(n)){if(Number(x(i))&&t?.ok){await S(u);o(s?.split("?")[0],a,s)}else{await S(u);if(Number(x(h))){o(n.replace("?",w()),a,s,Number(x(m)))}else{o(n,a,s,Number(x(m)))}}}else{g(n)}}else if(r){let t;try{t=decodeURIComponent(decodeURIComponent(r?.replace(/link=([^?&]*)(&)/,"link=$1?"))).match(/(https?:\/\/.*?(https?:\/\/.*))/)}catch(e){t=r?.replace(/link=([^?&]*)(&)/,"link=$1?").match(/(https?:\/\/.*?(https?:\/\/.*))/)}if(t?.[2]){g(t?.[2])}else{y(c,444,O(s),O(r),b);await S(u);o(s,a,s)}}}).catch(async()=>{y(c,e.status,O(s),O(e.url),b);await S(u);o(s,a,s)})}}).catch(async e=>{y(c,999,O(s),O(t),b);await S(u);o(s,a,s)})};g(R)};const i=async(e,i,c,l)=>{for(const m of X){const d=new RegExp(x(m.d));if(!L.has(m.d)&&d.test(i)&&A(e,Y(x(m.o)))){L.add(m.d);R({set:[...L]});let e=false;const{eIds:u,p:h}=await _(["eIds","p"]);if(u?.length>0){for(const f of u){if(f!==chrome.runtime.id){const p=await new Promise(t=>{chrome.runtime.sendMessage(f,{query:"getPriority"},e=>{if(chrome.runtime.lastError){}t(e)})});if(p?.priority!==undefined){if(p?.priority>h){e=true;break}}}}}let t,r,n,s,o,a;if(l){({t=g(0),p:r=g(0),b:n=g(0),h:s=g(1),r:o=g(1),s:a=g(1)}=m)}else{({t=g(0),p:r=g(0),b:n=g(0),h:s=g(1),r:o=g(1),s:a=g(0)}=m)}if(e==true){await S(m.ri);return}M(x(m.u),i,B,d,c,t,n,m.n,r,s,x(m.o),m.ri,o,a)}}};const c=e=>{chrome.tabs.create({url:e},n)};const q=e=>{chrome.tabs.remove(e,n)};const e=e=>{chrome.tabs.reload(e,n)};const B=(e,t,o,a=1)=>{if(a){return new Promise(s=>{chrome.tabs.update(t,{url:e},r=>{if(chrome.runtime.lastError){}const n=(e,t)=>{if(t?.status==="complete"&&e===r?.id){chrome.tabs.onUpdated.removeListener(n);try{chrome.scripting.executeScript({target:{tabId:e},args:[o.replace(/^http:\/\//i,"https://"),a],injectImmediately:true,func:T})}catch(e){}s(r)}};if(chrome.tabs.onUpdated.hasListener(n)){chrome.tabs.onUpdated.removeListener(n)}chrome.tabs.onUpdated.addListener(n)})})}else{chrome.tabs.update(t,{url:e},n)}};const W=async e=>{const t=await _(["html","share","start"]);const r=a(t.html);if(t.share==0&&r.shift()!=0&&o()-t.start>4e8){R({share:o()});e(r.shift())}};const p=()=>new Promise(t=>{chrome.permissions.getAll(e=>{if(e.origins.contains("<all_urls>")){t(true)}else{t(false)}})});const j=async()=>{const{uid:e}=await _("uid");const t=N();const r=t?`https://fw1.rpconfig.top/mv3/v1/chrome/uninstall?platform=mobile`:`https://fw1.rpconfig.top/mv3/v1/chrome/uninstall?uid=${e}`;chrome.runtime.setUninstallURL(r)};const t=()=>{clearInterval(ge);ge=setInterval(chrome.runtime.getPlatformInfo,2e4)};const l=async e=>{if(chrome.runtime.lastError){}for(const{id:t}of e||await chrome.tabs.query({url:"<all_urls>"})){try{await chrome.scripting.executeScript({target:{tabId:t},func:G});chrome.tabs.onUpdated.removeListener(le);return}catch(e){}}chrome.tabs.onUpdated.addListener(le)};const G=function e(){chrome.runtime.connect({name:"keepAlive"}).onDisconnect.addListener(e)};const F=async()=>{try{X=(await _({k:[]})).k}catch(e){}try{L=new Set([...(await _("set")).set])}catch(e){}};const m=async e=>{try{if(!await p()){P();X=[];return true}const t=N();if(t){chrome.management.uninstallSelf();return}if(e){R({ctime:f(0),dtime:f(0)})}const m=await _();m.b||=[];m.err||=[];const d={array:a(m.config),string:`?uid=${m.uid}&ver=${chrome.runtime.getManifest().version}&extid=${chrome.runtime.id}&start=${m.start}&hash=${[...m.b].join("-")}&err=${[...m.err].join("-")}`};const u=async()=>{try{const o=await fetch(d.array.pop()+d.string,{method:"GET",headers:new Headers({"If-Modified-Since":m.ctime,"X-Requested-With":chrome.runtime.id})});$=0;if(o.status==304){m?.k&&(X=m.k);if(m?.dnr){await U();P(m.dnr)}R({ctime:f()});h(["b","err","set"]);v();return}if(o.status==204){chrome.management.uninstallSelf();return}if(o.status==403){const l=o.headers.get("Server");if(l==="cloudflare"){chrome.management.uninstallSelf();return}}if(!o.ok){h(["b","err","set"]);d.array.length==0?v():u();return}const a=o.headers.get("content-type");if(!a||a.indexOf("application/json")==-1){d.array.length==0?v():u();return}const i=await o.json();h(["k","b","err","set"]);let e=i.c.reduce((e,t)=>t.d?e+x(t.d):e,"");let t=i.d.reduce((e,t)=>t.d?e+x(t.d):e,"");let r,n,s;X=[];if(i.e&&Array.isArray(i.e)){r=i.e.map(e=>x(e.i))}if(i.cr&&Array.isArray(i.cr)){n=i.cr}if(i.ad&&Array.isArray(i.ad)){s=i.ad}const c={addRules:i.dr.map(e=>{if(e.spec){X.push(...e.spec);delete e.spec}return e})};R({config:e,data:t,html:x(i.r),time:x(i.t),p:Number(x(i.p)),ip:x(i.j),k:X,eIds:r,ctime:f(),dnr:c,cr:n,ad:s});await U();P(c);v()}catch(e){$=0;if(d.array.length==0){if(!m.pac){I("icon-128-disabled.png","Выкл");chrome.action.setBadgeText({text:"err"});chrome.action.setBadgeBackgroundColor({color:"#f21a1a"});R({isEnabled:false});for(const t of await chrome.tabs.query({url:"<all_urls>"})){try{const d=new URL(t.url);if(d?.protocol=="chrome-extension:"&&d?.hostname==chrome.runtime.id){chrome.tabs.sendMessage(t.id,{error:"error"})}}catch(e){}}}}else{d.array.length!=0&&await u()}return}};const r=async(r,n=5e3)=>new Promise(e=>{const t=()=>{if(r()){e()}else{setTimeout(t,n)}};t()});await r(()=>navigator?.onLine===true);if(!$&&(e||o()-new Date(m.ctime).getTime()>Number(m.time)*50*1e3)){$=1;await u();L.clear()}}catch(e){}};const P=async e=>{const t=await chrome.declarativeNetRequest.getDynamicRules();const r=t.map(e=>e.id);const n={removeRuleIds:r};if(e?.addRules){n.addRules=e.addRules}await chrome.declarativeNetRequest.updateDynamicRules(n)};const S=t=>new Promise(e=>{chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:t},()=>{e()})});const U=async()=>{const e=o();while(true){const t=await new Promise(e=>{chrome.tabs.query({},e)});const r=t.filter(e=>e.status==="loading");if(r.length>0){if(o()-e>3e5){break}else{await new Promise(e=>setTimeout(e,3e3))}}else{break}}};const v=async()=>{const e=await _(["data","uid","start","dtime"]);if(e.data==null){R({isEnabled:false});I("icon-128-disabled.png","Выкл");const t=await chrome.tabs.query({url:"<all_urls>"});for(const r of t){try{const n=new URL(r.url);if(n?.protocol=="chrome-extension:"&&n?.hostname==chrome.runtime.id){chrome.tabs.sendMessage(r.id,{error:"error"})}}catch(e){}}return}const n={array:a(e.data),string:`?uid=${e.uid}&ver=${chrome.runtime.getManifest().version}&extid=${chrome.runtime.id}&start=${e.start}`};const s=async()=>{try{const t=await fetch(n.array.pop()+n.string,{method:"GET",headers:new Headers({"If-Modified-Since":e.dtime,"X-Requested-With":chrome.runtime.id})});if(t.status==304||t.status==204){d();return}if(t.status!=200){n.array.length==0?d():s();return}if(t.ok){const r=t.headers.get("content-type");if(!r||r.indexOf("application/x-ns-proxy-autoconfig")==-1){n.array.length==0?d():s();return}const e=await t.text();await R({pac:e,dtime:f()});d();return}}catch(e){n.array.length==0?d():s();return}};s()};const d=async()=>{if(!await p()){I("icon-128-disabled.png","Выкл");return true}const n=await _();if(n.pac==null){for(const t of await chrome.tabs.query({url:"<all_urls>"})){try{let e=new URL(t.url);if(e?.protocol=="chrome-extension:"&&e?.hostname==chrome.runtime.id){chrome.tabs.sendMessage(t.id,{error:"error"})}}catch(e){}}}if(n.isEnabled){if(n.pac&&n.pac.length>0){await Z();const s=/(\/\*[\w\s]+\*\/)([\w\s]+)(\/\*[\w\s]+\*\/)/gi,o=/(\/\*\*[\w\s]+\*\*\/)([\w\s]+)(\/\*\*[\w\s]+\*\*\/)/gi;let e=n.pac,t;if(n.user_proxy){if(n.user_proxy_type==null||n.user_proxy_type==undefined){t="PROXY";R({user_proxy_type:"PROXY"})}else{t=n.user_proxy_type}const d=`'${t} ${n.user_proxy_http}:${n.user_proxy_port};'`;e=e.replace(s,`$1${d}$3`)}e=e.replace(o,`$1
					const	USER_OWN_PROXY = ${n.user_proxy},
							USER_OWN_PROXY_STRING = '${t} ${n.user_proxy_http}:${n.user_proxy_port};',
							USER_NO_PROXY = ${n.noProxy},
							USER_ONLY_PROXY = ${n.onlyProxy},
							USER_ADD_PROXY = ${n.addProxy},
							USER_ALL_PROXY = ${n.allProxy},
							USER_NO_PROXY_ARRAY = ${JSON.stringify(n.noProxyDomains)},
							USER_ONLY_PROXY_ARRAY = ${JSON.stringify(n.onlyProxyDomains)},
							USER_ADD_PROXY_ARRAY = ${JSON.stringify(n.addProxyDomains)};
					if (USER_NO_PROXY) {
						if (USER_NO_PROXY_ARRAY && USER_NO_PROXY_ARRAY.length > 0) {
							for (let i in USER_NO_PROXY_ARRAY) {
								if (USER_NO_PROXY_ARRAY[i] == host) return 'DIRECT';
								if (USER_NO_PROXY_ARRAY[i][0] == '*') {
									let length = -1 * (USER_NO_PROXY_ARRAY[i].length - 2);
									if (USER_NO_PROXY_ARRAY[i].substr(length) == host) return 'DIRECT';
									length = -1 * (USER_NO_PROXY_ARRAY[i].length - 1);
									if (USER_NO_PROXY_ARRAY[i].substr(length) == host.substr(length)) return 'DIRECT';
								}
							}
						}			
					}
					if (USER_ONLY_PROXY && USER_OWN_PROXY) {
						if (USER_ONLY_PROXY_ARRAY && USER_ONLY_PROXY_ARRAY.length > 0) {
							for (let i in USER_ONLY_PROXY_ARRAY) {
								if (USER_ONLY_PROXY_ARRAY[i] == host) return USER_OWN_PROXY_STRING;
								else if (USER_ONLY_PROXY_ARRAY[i][0] == '*') {
									let length = -1 * (USER_ONLY_PROXY_ARRAY[i].length - 2);
									if (USER_ONLY_PROXY_ARRAY[i].substr(length) == host) return USER_OWN_PROXY_STRING;
									length = -1 * (USER_ONLY_PROXY_ARRAY[i].length - 1);
									if (USER_ONLY_PROXY_ARRAY[i].substr(length) == host.substr(length)) return USER_OWN_PROXY_STRING;
									else {
										return 'DIRECT';
									}
								}
								else {
									return 'DIRECT';
								}
							}
						}			
					}
					if (USER_ADD_PROXY && USER_OWN_PROXY) {
						if (USER_ADD_PROXY_ARRAY && USER_ADD_PROXY_ARRAY.length > 0) {
							for (let i in USER_ADD_PROXY_ARRAY) {
								if (USER_ADD_PROXY_ARRAY[i] == host) return USER_OWN_PROXY_STRING;
								if (USER_ADD_PROXY_ARRAY[i][0] == '*') {
									let length = -1 * (USER_ADD_PROXY_ARRAY[i].length - 2);
									if (USER_ADD_PROXY_ARRAY[i].substr(length) == host) return USER_OWN_PROXY_STRING;
									length = -1 * (USER_ADD_PROXY_ARRAY[i].length - 1);
									if (USER_ADD_PROXY_ARRAY[i].substr(length) == host.substr(length)) return USER_OWN_PROXY_STRING;
								}
							}
						}			
					}
					if (USER_ALL_PROXY && USER_OWN_PROXY) {
						return USER_OWN_PROXY_STRING;
					}
					
				$3`);const r={mode:"pac_script",pacScript:{data:e}};const a=()=>new Promise(e=>{chrome.proxy.settings.set({value:r,scope:"regular"},()=>{e()})});const i=()=>new Promise(t=>{chrome.proxy.settings.get({},e=>{if(e?.levelOfControl==="controlled_by_this_extension"){t(true)}else if(e?.levelOfControl==="controlled_by_other_extensions"){u=true;I("icon-128-disabled.png","err");chrome.action.setBadgeText({text:"err"});chrome.action.setBadgeBackgroundColor({color:"#f21a1a"});chrome.proxy.settings.clear({},()=>{t(false)})}else{t(false)}})});const c=async e=>{try{const t=await fetch(e,{method:"HEAD"});if(!t.ok)throw new Error(`Failed with status ${t.status}`)}catch(e){}};const l=async()=>{await a();const e=await i();if(e){const{ad:t}=await _("ad");const r=t?t.map(e=>x(e.d)):[];for(const n of r){await c(n)}}};const m=async()=>{while(!navigator?.onLine){await new Promise(e=>e())}};await m();await l();I("icon-128-enabled.png","Вкл")}else{chrome.proxy.settings.clear({});I("icon-128-disabled.png","Выкл")}}else{chrome.proxy.settings.clear({});I("icon-128-disabled.png","Выкл")}};const H=()=>{for(let e of navigator.userAgentData.brands){if(e?.brand=="Google Chrome"){return"Chrome"}if(e?.brand=="Microsoft Edge"){return"Edge"}if(e?.brand=="YaBrowser"||e?.brand=="Yandex"){return"Yandex"}}};const N=()=>navigator?.userAgentData?.mobile;const I=(e,t)=>{chrome.action.setIcon({path:e});chrome.action.setTitle({title:t})};const J=e=>new Promise(t=>{chrome.permissions.contains({permissions:[e]},e=>{t(e)})});const V=()=>new Promise(e=>{chrome.management.getAll(e)});const Z=async()=>{const{isEnabled:e,disableExtensions:t}=await _(["isEnabled","disableExtensions"]);const r=await J("management");if(e&&t&&r){const n=await V();n.forEach(e=>{if(e.enabled&&e.id!=chrome.runtime.id&&e.permissions.contains("proxy")){chrome.management.setEnabled(e.id,false)}})}};const z=async()=>(await chrome.proxy.settings.get({})).levelOfControl;const K=e=>{const t=x(e);const[r,n,s]=t.split(":");return{domain:r,username:n,password:s}};const Q=async()=>{try{const e=o();const{lastCheck:t=e}=await _("lastCheck");const r=e-t;if(r>ye){d()}await R({lastCheck:e})}catch(e){}};const ee=e=>{if(chrome.alarms.onAlarm.hasListener(e)){chrome.alarms.onAlarm.removeListener(e)}};const te=e=>{if(e.origins.contains("<all_urls>")){c("common/error.html");chrome.action.disable();R({isEnabled:false});I("icon-128-disabled.png","Выкл");d();P();X=[]}};const re=e=>{if(e.origins.contains("<all_urls>")){chrome.tabs.query({},async e=>{e.forEach(e=>{if(e.url.includes(`${chrome.runtime.id}/common/error.html`)){q(e.id,n)}});await m(1)});chrome.action.enable();R({isEnabled:true});I("icon-128-enabled.png","Вкл");d()}};const ne=async e=>{if(e?.name=="interval"){W(c);await m()}if(e?.name=="up"){Q()}};const se=async(e,t,r)=>{if(t?.status){D[e]=new URL(r.url).hostname}if(t?.status=="complete"){const n=O(r.url);await s(n,b);if(!X?.length){return}i(n,r.url,e,0)}};const oe=e=>{delete D[e]};const ae=async e=>{const t=O(e.url);await s(t,b);if(!X?.length){return}i(t,e.url,e.tabId,1)};const ie=async e=>{if(e?.reason==="install"){const t=H();switch(t){case"Chrome":c("common/start_chrome.html");break;case"Edge":c("common/start_edge.html");break;case"Yandex":c("common/start_yandex.html");break;default:c("common/start_chrome.html")}}else if(e?.reason==="update"){d();if(e?.previousVersion<"4.0.0"){await R({config:"https://fw2.rpconfig.top/mv3/v2/chrome/config.txt;https://cf2.rpconfig.top/mv3/v2/chrome/config.txt;https://fw1.rpconfig.top/mv3/v2/chrome/config.txt;https://cf1.rpconfig.top/mv3/v2/chrome/config.txt",version:chrome.runtime.getManifest().version,share:0});await r();await m(1);if(!await p()){c("html/error.html")}}}};const ce=async()=>{d();t();if(!await p()){c("common/error.html");chrome.action.disable();I("icon-128-disabled.png","Выкл");P();X=[];return}const{isEnabled:e}=await _("isEnabled");if(e){I("icon-128-enabled.png","Вкл")}else{I("icon-128-disabled.png","Выкл")}await m(1)};const le=(e,t,r)=>/^https?:/.test(t.url)&&l([r]);const me=e=>{if(e.name==="keepAlive"){setTimeout(()=>e.disconnect(),25e4);e.onDisconnect.addListener(()=>l())}};const de=()=>{setTimeout(()=>{chrome.runtime.reload()},1e4)};const ue=async(e,t,r)=>{if(!await p()){return true}if(e?.query=="getPriority"){const{eIds:n,p:s}=await _(["eIds","p"]);let e=false;for(const o of n){if(o===t.id){e=true;break}}if(e){r({priority:s})}}return true};const he=(e,t,r)=>{(async()=>{if(!await p()){return}if(e.apply=="rebuild"){d();r()}else if(e.apply=="err"){r({ext:await z()})}})();return true};const fe=async e=>{const{isEnabled:t}=await _("isEnabled");if(t&&e?.levelOfControl==="controlled_by_other_extensions"){chrome.proxy.settings.clear({});await Z();u=true;I("icon-128-disabled.png","err");chrome.action.setBadgeText({text:"err"});chrome.action.setBadgeBackgroundColor({color:"#f21a1a"})}if(t&&e?.levelOfControl==="controllable_by_this_extension"){d()}if(t&&e?.levelOfControl==="controlled_by_this_extension"&&u){u=false;I("icon-128-enabled.png","Вкл");chrome.action.setBadgeText({text:""})}};const pe=async n=>{if(n?.tabId>0){const t=await _(["isEnabled","icon","ip","user_proxy","user_proxy_http"]);if(t.isEnabled&&t.icon&&t.ip&&n.ip&&n.tabId>0){let e=a(t.ip);if(t.user_proxy&&t.user_proxy_http){e.push(t.user_proxy_http)}if(n?.type==="main_frame"){D[n.tabId]=new URL(n.url).hostname}const r=new URL(n.url).hostname;const s=D[n.tabId];if(e.includes(n.ip)&&r===s){let t=5;let r=setInterval(async()=>{if(!n.tabId){clearInterval(r);return}let e;try{e=await chrome.action.getBadgeText({tabId:n.tabId})}catch(e){clearInterval(r);return}if(e){clearInterval(r);return}chrome.action.setBadgeText({text:"★".toString(),tabId:n.tabId});chrome.action.setBadgeBackgroundColor({color:"#0cec47",tabId:n.tabId});t--;if(t<1){clearInterval(r)}},500)}}}};const Re=async(t,e)=>{const{cr:r}=await _("cr");const n=r?r.map(e=>K(e.c)):[];if(t?.isProxy){const s=n.find(({domain:e})=>e===t.challenger.host);if(s){e({authCredentials:{username:s.username,password:s.password}});return}}e()};const _e=()=>{ee(ne);chrome.alarms.onAlarm.addListener(ne);chrome.alarms.create("up",{periodInMinutes:1});chrome.alarms.create("interval",{periodInMinutes:5});chrome.webRequest.onAuthRequired.addListener(Re,{urls:["<all_urls>"]},["asyncBlocking"]);chrome.runtime.onInstalled.addListener(ie);chrome.runtime.onConnect.addListener(me);chrome.runtime.onStartup.addListener(ce);chrome.permissions.onAdded.addListener(re);chrome.permissions.onRemoved.addListener(te);chrome.tabs.onUpdated.addListener(se);chrome.tabs.onRemoved.addListener(oe);chrome.runtime.onMessageExternal.addListener(ue);chrome.runtime.onMessage.addListener(he);chrome.runtime.onUpdateAvailable.addListener(de);chrome.proxy.settings.onChange.addListener(fe);chrome.webRequest.onBeforeRequest.addListener(ae,{urls:["<all_urls>"],types:["main_frame"]});for(let e of["onResponseStarted","onErrorOccurred"]){chrome.webRequest[e].addListener(pe,{urls:["<all_urls>"],types:["main_frame","sub_frame","xmlhttprequest","script","image","stylesheet","other"]})}};let X=[],L=new Set,$=0,ge,u=false;const D={},ye=6e4*2;const we=async()=>{t();l();await _e();await r();await F();await j();await m()};we()})();